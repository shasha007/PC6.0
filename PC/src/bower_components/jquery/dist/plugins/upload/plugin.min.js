tinymce.PluginManager.add("upload",function(editor){

    /**
     * 选择文件上传
     */
    function selectFile(){
        var fileDom = document.createElement("input");
        fileDom.type = "file";
        fileDom.click();
        fileDom.addEventListener("change",function(e){
            uploadFile(e.target.files);
        });
    }

    /**
     * 拖拽上传
     */
    function dragUpload(){
        // 创建拖拽上传域
        var dragBox = document.createElement("div");
        dragBox.className = "mce-drag-box";
        editor.getElement().parentNode.appendChild(dragBox);

        /********************************************* 不小心直接拖放到编辑器上的时候 ****************************/
        // 拖拽上传 - 拖拽到浏览器的时候
        editor.getDoc().addEventListener('dragenter',function(e){
            e.stopPropagation();
            e.preventDefault();
            dragBox.className = "mce-drag-box mce-drag-able";
        });

        /********************************************* 拖到浏览器上的时候 *************************************/
        // 拖拽上传 - 拖拽到浏览器的时候
        document.addEventListener('dragenter',function(e){
            dragBox.className = "mce-drag-box mce-drag-able";
        });

        // 拖拽上传 - 拖拽离开浏览器的时候
        document.addEventListener('dragover',function (e) {
            dragBox.className = "mce-drag-box mce-drag-able";
        });

        // 拖拽上传 - 托转离开浏览器的时候
        document.addEventListener('dragleave',function(e){
            console.log("离开浏览器");
            dragBox.className = "mce-drag-box";
        });

        /********************************************* 拖放到上传框的时候 *************************************/
        // 拖拽上传 - 拖放到box上时
        dragBox.addEventListener("dragover",function(e){
            //e.stopPropagation();
            e.preventDefault();
            dragBox.className = "mce-drag-box mce-drag-on";
        },false);

        // 拖拽上传 - 离开box时
        dragBox.addEventListener("dragleave",function(e){
            //e.stopPropagation();
            e.preventDefault();
            dragBox.className = "mce-drag-box mce-drag-able";
        },false);

        // 拖拽上传 - 放开后开始上传
        dragBox.addEventListener("drop",function(e){
            //e.stopPropagation();
            e.preventDefault();
            dragBox.className = "mce-drag-box mce-updating";
            uploadFile(e.dataTransfer.files);
        },false);
    }

    /**
     * 上传操作
     * @param files
     */
    function uploadFile(files){
        var xhr = null;
        if (window.XMLHttpRequest){
            xhr = new XMLHttpRequest();
        }else if(window.ActiveXObject){
            xhr = new ActiveXObject("Microsoft.XMLHTTP");
        }else{
            alert("您的浏览器不支持Ajax上传")
        }
        if (!window.FormData){
            alert("您的浏览器版本太低，推荐使用支持HTML5标准的浏览器");
        }
        var formData = new FormData();
        for (var i = 0 ;i < files.length; i++){
            formData.append("files",files[i]);
        }
        console.log(formData);
        xhr.open("post",editor.settings.upload_url,true);
        console.log(formData);
        xhr.send(formData);

        // 开始上传的时候
        xhr.addEventListener("loadstart",function(){
            //console.log(111);
        });

        // 上传完成后
        xhr.addEventListener("readystatechange",function(){
            //console.log(2222);
        });

        xhr.addEventListener("load",function(){
            if (xhr.readyState == 4 && xhr.status == 200) {
                var response = JSON.parse(xhr.responseText);
                if (response.code == 1) {
                    var image = '';
                    if (response.content.length > 0){
                        for(var i = 0;i<response.content.length;i++){
                            image += '<img src="'+editor.settings.base_uri + response.content[i].url+'" />';
                        }
                        editor.insertContent(image);
                    }
                }
            }else{
                alert("上传失败");
            }
        })
    }

    // 初始化插件
    editor.on("preInit",function(){
        // 支持拖拽上传
        dragUpload();
    }),editor.addButton("upload",{
        title:"上传",
        icon:false,
        onclick:function(){
            selectFile();
        }
    }),editor.addMenuItem("upload",{
        title:"上传",
        icon:false,
        onclick:function(){
            selectFile();
        }
    }),editor.addCommand("mceUpload",function(e){

    })
})